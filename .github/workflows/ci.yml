name: CI

on:
  push:
  pull_request:

jobs:
  locust-pass:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Locust example (pass)
        id: run_pass
        uses: ./.
        with:
          locust_file: examples/basic/locustfile.py
          host: https://httpbin.org
          users: 5
          spawn_rate: 5
          run_time: 10s
          log_level: INFO
          check_fail_ratio: 0.05
          check_avg_response_time: 4000
          check_p95_response_time: 8000
          output_dir: locust-report
          csv_prefix: locust_stats
          html_report: true
          upload_artifacts: true
          artifact_name: locust-report-pass

      - name: Print outputs
        run: |
          echo "fail_ratio=${{ steps.run_pass.outputs.fail_ratio }}"
          echo "avg_response_time=${{ steps.run_pass.outputs.avg_response_time }}"
          echo "p95_response_time=${{ steps.run_pass.outputs.p95_response_time }}"
          echo "total_requests=${{ steps.run_pass.outputs.total_requests }}"
          echo "total_failures=${{ steps.run_pass.outputs.total_failures }}"
          echo "thresholds_passed=${{ steps.run_pass.outputs.thresholds_passed }}"

  locust-fail:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create failing locustfile
        run: |
          mkdir -p examples/failing
          printf '%s\n' \
            'from locust import HttpUser, task, between' \
            '' \
            'class FailingUser(HttpUser):' \
            '    wait_time = between(0.1, 0.2)' \
            '' \
            '    @task' \
            '    def fail(self):' \
            '        self.client.get("/status/500", name="fail")' \
            > examples/failing/locustfile.py

      - name: Run Locust example (expected fail)
        id: run_fail
        uses: ./.
        continue-on-error: true
        with:
          locust_file: examples/failing/locustfile.py
          host: https://httpbin.org
          users: 2
          spawn_rate: 2
          run_time: 5s
          check_fail_ratio: 0.0
          upload_artifacts: false

      - name: Assert failure occurred
        if: always()
        run: |
          echo "Step outcome: ${{ steps.run_fail.outcome }}"
          if [ "${{ steps.run_fail.outcome }}" != "failure" ]; then
            echo "Expected failure but step succeeded" >&2
            exit 1
          fi

