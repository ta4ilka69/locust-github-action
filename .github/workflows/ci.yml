name: CI

on:
  push:
  pull_request:

jobs:
  locust-pass:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Locust example (pass)
        id: run_pass
        uses: ./. 
        with:
          locust-file: examples/basic/locustfile.py
          host: https://httpbin.org
          users: 5
          spawn-rate: 5
          run-time: 10s
          log-level: INFO
          check-fail-ratio: 0.05
          check-avg-response-time: 4000
          check-p95-response-time: 8000
          output-dir: locust-report
          csv-prefix: locust_stats
          html-report: true
          upload-artifacts: true
          artifact-name: locust-report-pass

      - name: Print outputs
        run: |
          echo "fail_ratio=${{ steps.run_pass.outputs.fail_ratio }}"
          echo "avg_response_time=${{ steps.run_pass.outputs.avg_response_time }}"
          echo "p95_response_time=${{ steps.run_pass.outputs.p95_response_time }}"
          echo "total_requests=${{ steps.run_pass.outputs.total_requests }}"
          echo "total_failures=${{ steps.run_pass.outputs.total_failures }}"
          echo "thresholds_passed=${{ steps.run_pass.outputs.thresholds_passed }}"

  locust-fail:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create failing locustfile
        run: |
          mkdir -p examples/failing
          cat > examples/failing/locustfile.py << 'PY'
from locust import HttpUser, task, between

class FailingUser(HttpUser):
    wait_time = between(0.1, 0.2)

    @task
    def fail(self):
        self.client.get("/status/500", name="fail")
PY

      - name: Run Locust example (expected fail)
        id: run_fail
        uses: ./. 
        continue-on-error: true
        with:
          locust-file: examples/failing/locustfile.py
          host: https://httpbin.org
          users: 2
          spawn-rate: 2
          run-time: 5s
          check-fail-ratio: 0.0
          upload-artifacts: false

      - name: Assert failure occurred
        if: always()
        run: |
          echo "Step outcome: ${{ steps.run_fail.outcome }}"
          if [ "${{ steps.run_fail.outcome }}" != "failure" ]; then
            echo "Expected failure but step succeeded" >&2
            exit 1
          fi

