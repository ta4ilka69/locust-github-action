name: CI

on:
  push:
  pull_request:

jobs:
  locust-pass:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Locust
        run: pip install locust

      - name: Start local test server
        run: |
          nohup python examples/server/simple_server.py > server.log 2>&1 &
          echo $! > server.pid
          sleep 2

      - name: Run Locust example (pass)
        id: run_pass
        uses: ./.
        with:
          locust_file: examples/basic/locustfile.py
          args: --host http://127.0.0.1:8000 -u 5 -r 5 -t 10s --loglevel INFO
          csv_base: locust-report/locust_stats
          html_report: true
          upload_artifacts: true
          artifact_name: locust-report-pass

      - name: Print outputs
        run: |
          echo "fail_ratio=${{ steps.run_pass.outputs.fail_ratio }}"
          echo "avg_response_time=${{ steps.run_pass.outputs.avg_response_time }}"
          echo "p95_response_time=${{ steps.run_pass.outputs.p95_response_time }}"
          echo "total_requests=${{ steps.run_pass.outputs.total_requests }}"
          echo "total_failures=${{ steps.run_pass.outputs.total_failures }}"

      - name: Stop local test server
        if: always()
        run: |
          if [ -f server.pid ]; then kill "$(cat server.pid)" || true; fi

  missing-host:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Locust
        run: pip install locust

      - name: Run without host (should fail)
        id: no_host
        uses: ./.
        continue-on-error: true
        with:
          locust_file: examples/basic/locustfile.py

      - name: Assert failure (missing host)
        run: |
          echo "Step outcome: ${{ steps.no_host.outcome }}"
          if [ "${{ steps.no_host.outcome }}" != "failure" ]; then
            echo "Expected failure due to missing host" >&2
            exit 1
          fi

  missing-locustfile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Locust
        run: pip install locust

      - name: Run without locust_file (should fail)
        id: no_locustfile
        uses: ./.
        continue-on-error: true
        with:
          args: --host http://127.0.0.1:8000

      - name: Assert failure (missing locust_file)
        run: |
          echo "Step outcome: ${{ steps.no_locustfile.outcome }}"
          if [ "${{ steps.no_locustfile.outcome }}" != "failure" ]; then
            echo "Expected failure due to missing locust_file" >&2
            exit 1
          fi

  tags-include-fast:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Locust
        run: pip install locust

      - name: Use tags example
        run: echo "Using examples/tags/locustfile.py"

      - name: Start local test server
        run: |
          nohup python examples/server/simple_server.py > server.log 2>&1 &
          echo $! > server.pid
          sleep 2

      - name: Run with tags include (fast)
        uses: ./.
        with:
          locust_file: examples/tags/locustfile.py
          args: --host http://127.0.0.1:8000 -u 4 -r 4 -t 6s --tags fast
          upload_artifacts: false

      - name: Stop local test server
        if: always()
        run: |
          if [ -f server.pid ]; then kill "$(cat server.pid)" || true; fi

  tags-exclude-slow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Locust
        run: pip install locust

      - name: Use tags example
        run: echo "Using examples/tags/locustfile.py"

      - name: Start local test server
        run: |
          nohup python examples/server/simple_server.py > server.log 2>&1 &
          echo $! > server.pid
          sleep 2

      - name: Run with exclude-tags (slow)
        uses: ./.
        with:
          locust_file: examples/tags/locustfile.py
          args: --host http://127.0.0.1:8000 -u 4 -r 4 -t 6s --exclude-tags slow
          upload_artifacts: false

      - name: Stop local test server
        if: always()
        run: |
          if [ -f server.pid ]; then kill "$(cat server.pid)" || true; fi

  custom-outputs-and-args:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Locust
        run: pip install locust

      - name: Start local test server
        run: |
          nohup python examples/server/simple_server.py > server.log 2>&1 &
          echo $! > server.pid
          sleep 2

      - name: Run with custom outputs and args
        uses: ./.
        with:
          locust_file: examples/basic/locustfile.py
          args: --host http://127.0.0.1:8000 -u 3 -r 3 -t 5s --loglevel DEBUG --stop-timeout 1
          csv_base: out/my_stats
          html_report: false
          upload_artifacts: false

      - name: Verify CSV exists
        run: |
          test -f out/my_stats_stats.csv

      - name: Stop local test server
        if: always()
        run: |
          if [ -f server.pid ]; then kill "$(cat server.pid)" || true; fi

  version-pin-and-reqs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python (cached)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Create requirements
        run: |
          echo 'locust==2.42.1' > requirements.txt
          echo 'requests==2.32.4' >> requirements.txt
      - name: Install from requirements
        run: pip install -r requirements.txt

      - name: Start local test server
        run: |
          nohup python examples/server/simple_server.py > server.log 2>&1 &
          echo $! > server.pid
          sleep 2

      - name: Run with pinned versions
        uses: ./.
        with:
          locust_file: examples/basic/locustfile.py
          args: --host http://127.0.0.1:8000 -u 2 -r 2 -t 5s
          csv_base: locust-report/locust_stats
          upload_artifacts: false

      - name: Stop local test server
        if: always()
        run: |
          if [ -f server.pid ]; then kill "$(cat server.pid)" || true; fi
